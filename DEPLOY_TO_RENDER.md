# üöÄ Deploy to Render - Complete Guide

This guide will walk you through deploying your chat application backend to Render using Cloudflare R2 for database persistence.

## üìã Prerequisites

- A GitHub account
- A Render account (sign up at https://render.com)
- Cloudflare R2 account (configured)

## üîß Step 1: Create R2 Bucket

Before deploying, create your R2 bucket:

1. Go to [Cloudflare Dashboard](https://dash.cloudflare.com)
2. Navigate to **R2** ‚Üí **Buckets**
3. Click **Create bucket**
4. Name it: `chat-app-db`
5. Select region: **European Union (EU)**

## üì§ Step 2: Prepare Your Repository

### Option A: Push to GitHub (Recommended)

1. Initialize git in the backend folder:
   ```bash
   cd backend
   git init
   git add .
   git commit -m "Initial commit - Ready for deployment"
   ```

2. Create a GitHub repository:
   - Go to https://github.com/new
   - Create a new repository (e.g., `chat-app-backend`)
   - **DO NOT** add README, .gitignore, or license

3. Push your code:
   ```bash
   git remote add origin https://github.com/YOUR_USERNAME/YOUR_REPO_NAME.git
   git branch -M main
   git push -u origin main
   ```

### Option B: Use Render's Git Feature

1. Go to Render dashboard
2. Connect your local repository

## üéØ Step 3: Deploy on Render

1. Go to https://dashboard.render.com
2. Click **New** ‚Üí **Web Service**
3. Connect your GitHub repository
4. Configure the service:
   - **Name**: `chat-backend`
   - **Region**: Choose closest to your users
   - **Branch**: `main`
   - **Runtime**: `Docker`
   - **Build Command**: Leave empty (handled by Dockerfile)
   - **Start Command**: Leave empty (handled by Dockerfile)

## üîê Step 4: Configure Environment Variables

Click on your service ‚Üí **Environment** tab, and add these variables:

### Required Environment Variables

#### Core Application
```env
APP_ENV=prod
SECRET_KEY=<will be auto-generated by Render>
DATABASE_URL=sqlite:////data/app.db
CORS_ORIGINS=https://your-frontend-domain.com,http://localhost:4200
```

#### Security Settings
```env
ENABLE_SECURITY_HEADERS=true
ENABLE_CORS=true
COOKIE_SECURE=true
COOKIE_SAMESITE=strict
ENABLE_RATE_LIMITING=true
LOG_LEVEL=INFO
LOG_FORMAT=json
```

#### AI Configuration (Hugging Face)
```env
AI_PROVIDER=huggingface
HF_TOKEN=your-huggingface-token-here
HF_MODEL=meta-llama/Llama-3.1-8B-Instruct
```

#### Database Replication (Litestream + R2)
```env
LITESTREAM_ACCESS_KEY_ID=your-r2-access-key-here
LITESTREAM_SECRET_ACCESS_KEY=your-r2-secret-key-here
LITESTREAM_ENDPOINT=https://your-account-id.r2.cloudflarestorage.com
LITESTREAM_BUCKET=aiagentapp
```

**‚ö†Ô∏è SECURITY WARNING**: Replace placeholder values with your actual credentials. These secrets MUST be set in Render Dashboard ‚Üí Environment Variables, NOT committed to the repository. See [SECRET_MANAGEMENT_GUIDE.md](SECRET_MANAGEMENT_GUIDE.md) for instructions.

### Environment Variables Summary in Render

| Variable Name | Value | Notes |
|--------------|-------|-------|
| `APP_ENV` | `prod` | Production mode |
| `SECRET_KEY` | *(auto-generated by Render)* | Keep the generated value |
| `CORS_ORIGINS` | Update with your frontend URL | |
| `LITESTREAM_ACCESS_KEY_ID` | Your R2 Access Key ID | Get from Cloudflare R2 dashboard |
| `LITESTREAM_SECRET_ACCESS_KEY` | Your R2 Secret Access Key | Get from Cloudflare R2 dashboard |
| `LITESTREAM_ENDPOINT` | Your R2 endpoint URL | Format: `https://your-account-id.r2.cloudflarestorage.com` |
| `LITESTREAM_BUCKET` | `aiagentapp` | Your bucket name |
| `HF_TOKEN` | Your HuggingFace API token | Get from https://huggingface.co/settings/tokens |

**‚ö†Ô∏è IMPORTANT**: All secrets must be set in Render Dashboard, not in code. See [SECRET_MANAGEMENT_GUIDE.md](SECRET_MANAGEMENT_GUIDE.md) for step-by-step instructions.

## ‚öôÔ∏è Step 5: Advanced Settings

In Render dashboard, under **Advanced**:

1. **Health Check Path**: `/health`
2. **Disk**: 
   - Name: `app-data`
   - Mount Path: `/data`
   - Size: `1 GB`

## üöÄ Step 6: Deploy

1. Click **Create Web Service**
2. Wait for the build to complete (first build takes 5-10 minutes)
3. Your service will be available at: `https://your-service.onrender.com`

## ‚úÖ Step 7: Verify Deployment

1. Check health endpoint:
   ```bash
   curl https://your-service.onrender.com/health
   ```

2. Check logs in Render dashboard for any errors

3. Verify database replication:
   - Check R2 bucket for database backups
   - Each backup is stored with timestamp

## üîç Monitoring & Logs

- **View Logs**: Render Dashboard ‚Üí Your Service ‚Üí Logs
- **Metrics**: Available in Render Pro plan
- **Database Backups**: Automatically synced to R2 every hour

## üîÑ Deployment Updates

Every push to the `main` branch will trigger automatic deployment:

```bash
git add .
git commit -m "Update code"
git push origin main
```

## üõ†Ô∏è Troubleshooting

### Build Fails
- Check Dockerfile syntax
- Verify all environment variables are set
- Review build logs in Render dashboard

### Service Crashes
- Check application logs
- Verify database path is correct: `/data/app.db`
- Ensure R2 credentials are correct

### Database Not Persisting
- Verify R2 bucket exists and credentials are correct
- Check Litestream logs in application output
- Ensure disk is properly mounted

### AI Not Working
- Verify `HF_TOKEN` is correct
- Check `AI_PROVIDER` is set to `huggingface` (not `mock`)
- Check model name is correct

## üí∞ Costs

### Render Free Tier
- 750 hours/month free
- Service sleeps after 15 minutes of inactivity
- Cold start takes ~30 seconds

### Cloudflare R2
- Free tier: 10 GB storage + 1M Class A operations/month
- Database backups are infrequent (1 hour sync)
- Estimated cost: $0-1/month

### Hugging Face
- Free tier: 30K API calls/month
- Rate limits apply

## üîê Security Notes

1. **Never commit `.env.num` file** to git - it's in `.gitignore`
2. **‚ö†Ô∏è CRITICAL for Public Repositories**: Since Render free tier requires public repos, you MUST:
   - Set all secrets in Render Dashboard ‚Üí Environment Variables
   - Never commit real API keys, tokens, or credentials to the repository
   - Use `.env.example` as a template (never commit real values)
   - See [SECRET_MANAGEMENT_GUIDE.md](SECRET_MANAGEMENT_GUIDE.md) for detailed instructions
3. **SECRET_KEY** is auto-generated by Render (secure and random)
4. **Update CORS_ORIGINS** with your actual frontend domain
5. **Enable rate limiting** in production
6. **Rotate secrets** if they are ever accidentally exposed

## üìù Next Steps

1. Update frontend API endpoint to point to your Render service
2. Configure custom domain (optional)
3. Set up monitoring and alerts
4. Configure automated backups

## üìû Support

- Render Docs: https://render.com/docs
- Render Support: support@render.com
- Cloudflare R2 Docs: https://developers.cloudflare.com/r2

---

**Your deployment is ready!** üéâ

Your backend will be available at: `https://your-service-name.onrender.com`

Update your frontend to use this URL instead of `http://localhost:8000`

