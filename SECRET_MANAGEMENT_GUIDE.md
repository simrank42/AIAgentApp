# üîê Secret Management Guide for Render Free Tier

## ‚ö†Ô∏è Critical Security Information

**Since Render's free tier requires public repositories**, you MUST handle all secrets differently than with private repositories. This guide explains how to securely manage API keys, tokens, and credentials.

---

## Why This Matters

1. **Public repositories** are visible to anyone on GitHub
2. **Exposed secrets** can be used by attackers to:
   - Access your AI API (costing you money)
   - Access your database backups
   - Compromise your application
3. **Git history** preserves secrets even if you later remove them
4. **Once exposed, secrets must be rotated** immediately

---

## ‚úÖ Best Practices

### DO:
- ‚úÖ Set all secrets in **Render Dashboard ‚Üí Environment Variables**
- ‚úÖ Use `.env.example` as a template (with placeholders only)
- ‚úÖ Keep `.env` file locally and add it to `.gitignore`
- ‚úÖ Use placeholder values in documentation
- ‚úÖ Rotate secrets immediately if they are exposed
- ‚úÖ Use different secrets for development and production

### DON'T:
- ‚ùå Commit real secrets to the repository
- ‚ùå Put secrets in `render.yaml` values
- ‚ùå Share secrets in documentation files
- ‚ùå Put secrets in code comments
- ‚ùå Use the same secrets across environments

---

## üìã Required Secrets

Your application needs these secrets (set in Render Dashboard only):

### 1. **SECRET_KEY** (Auto-generated)
- **Purpose**: JWT token signing
- **How to get**: Auto-generated by Render (uses `generateValue: true`)
- **Action**: No action needed - Render handles this

### 2. **HF_TOKEN** (HuggingFace API Token)
- **Purpose**: Access to HuggingFace AI models
- **How to get**: 
  1. Go to https://huggingface.co/settings/tokens
  2. Create a new token (read access is sufficient)
  3. Copy the token (starts with `hf_...`)
- **Where to set**: Render Dashboard ‚Üí Your Service ‚Üí Environment ‚Üí Add `HF_TOKEN`

### 3. **LITESTREAM_ACCESS_KEY_ID** (Cloudflare R2 Access Key)
- **Purpose**: Database backup to Cloudflare R2
- **How to get**:
  1. Go to https://dash.cloudflare.com ‚Üí R2
  2. Click "Manage R2 API Tokens"
  3. Create API Token
  4. Give it read/write permissions
  5. Copy the Access Key ID
- **Where to set**: Render Dashboard ‚Üí Your Service ‚Üí Environment ‚Üí Add `LITESTREAM_ACCESS_KEY_ID`

### 4. **LITESTREAM_SECRET_ACCESS_KEY** (Cloudflare R2 Secret Key)
- **Purpose**: Database backup to Cloudflare R2
- **How to get**: From the same R2 API Token creation (step 3 above)
- **Where to set**: Render Dashboard ‚Üí Your Service ‚Üí Environment ‚Üí Add `LITESTREAM_SECRET_ACCESS_KEY`
- **‚ö†Ô∏è Important**: Save this immediately - you can only see it once!

### 5. **LITESTREAM_ENDPOINT** (Can be public, but recommend setting in dashboard)
- **Purpose**: R2 endpoint URL
- **Format**: `https://your-account-id.r2.cloudflarestorage.com`
- **How to get**: From Cloudflare R2 dashboard ‚Üí Your bucket ‚Üí Settings
- **Where to set**: Render Dashboard (optional, can be in config file)

### 6. **LITESTREAM_BUCKET** (Can be public)
- **Purpose**: R2 bucket name for backups
- **Value**: `aiagentapp` (or your bucket name)
- **Where to set**: Can be in `render.yaml` or Render Dashboard

---

## üöÄ Step-by-Step: Setting Secrets in Render Dashboard

### Step 1: Access Environment Variables
1. Go to https://dashboard.render.com
2. Click on your web service (`chat-backend`)
3. Click on **"Environment"** tab in the left sidebar

### Step 2: Add Each Secret
For each secret:
1. Click **"Add Environment Variable"**
2. Enter the **Key** (e.g., `HF_TOKEN`)
3. Enter the **Value** (paste your actual secret)
4. Click **"Save Changes"**

### Step 3: Add All Required Secrets
Add these variables one by one:

```env
HF_TOKEN=your-actual-huggingface-token-here
LITESTREAM_ACCESS_KEY_ID=your-actual-r2-access-key-here
LITESTREAM_SECRET_ACCESS_KEY=your-actual-r2-secret-key-here
LITESTREAM_ENDPOINT=https://your-account-id.r2.cloudflarestorage.com
```

### Step 4: Verify Secrets Are Set
1. Scroll through the Environment Variables list
2. Verify all required secrets are present
3. **Do not** check the "Show Values" box in screenshots you share!

### Step 5: Redeploy
After adding secrets:
1. Click **"Manual Deploy"** ‚Üí **"Deploy latest commit"**
2. Or push a new commit to trigger automatic deployment
3. Check logs to verify secrets are loaded correctly

---

## üîç Verifying Secrets Are Loaded

### Check Application Logs
1. Go to Render Dashboard ‚Üí Your Service ‚Üí **Logs**
2. Look for startup messages
3. If secrets are missing, you'll see warnings (see below)

### Expected Startup Messages
If secrets are configured correctly, you should see:
```
‚úÖ Starting application...
‚úÖ Database found locally
üîÑ Starting Litestream replication...
‚úÖ Litestream sync complete
üîß Running database migrations...
üåê Starting Uvicorn server...
```

### Missing Secrets Warnings
If secrets are missing, you might see:
```
‚ö†Ô∏è  Warning: HF_API_KEY not set - AI features will use mock mode
‚ö†Ô∏è  Warning: Litestream credentials not configured - database backups disabled
```

---

## üõ°Ô∏è What to Do If Secrets Are Exposed

### Immediate Actions (Within Minutes)
1. **Rotate the secret immediately**:
   - For HuggingFace: Revoke old token, create new one
   - For R2: Delete old API token, create new one
2. **Update Render Dashboard** with new values
3. **Redeploy** your application

### Check for Unauthorized Access
1. Check HuggingFace usage logs for unexpected API calls
2. Check R2 bucket for unexpected file accesses
3. Monitor application logs for unusual activity

### Clean Up Git History (If Secret Was Committed)
‚ö†Ô∏è **Warning**: This rewrites git history and requires force push

```bash
# Remove secret from all git history (BE CAREFUL!)
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch FILE_WITH_SECRET" \
  --prune-empty --tag-name-filter cat -- --all

# Force push (coordinate All team members!)
git push origin --force --all
```

**Alternative**: Consider creating a new repository if the secret has been public for a while.

---

## üìö Additional Resources

- [Render Environment Variables Docs](https://render.com/docs/environment-variables)
- [GitHub Secret Scanning](https://docs.github.com/en/code-security/secret-scanning)
- [HuggingFace Token Management](https://huggingface.co/settings/tokens)
- [Cloudflare R2 API Tokens](https://developers.cloudflare.com/r2/api/s3/tokens/)

---

## ‚úÖ Security Checklist

Before deploying to production:

- [ ] All secrets removed from documentation files
- [ ] All secrets use placeholders in `render.yaml`
- [ ] `.env` file is in `.gitignore`
- [ ] `.env.example` exists with placeholders only
- [ ] All secrets set in Render Dashboard
- [ ] Application starts successfully with secrets from Render
- [ ] No secrets visible in git history (`git log -p` to verify)
- [ ] Team members know not to commit secrets

---

## üÜò Need Help?

If you're unsure about secret management:
1. Check this guide first
2. Review Render's documentation
3. Ask in your team (but never share actual secret values!)

---

**Remember**: Security is not optional. Taking a few minutes to set secrets correctly can save you from costly security incidents!

