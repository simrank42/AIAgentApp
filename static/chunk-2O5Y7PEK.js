import{a as f,e as y,f as g}from"./chunk-6GHKOAKW.js";import{B as d,q as p,u}from"./chunk-QCJJ4XD2.js";var c=class c{constructor(){this.auth=u(y);this.toast=u(g);this.ws=null;this.streamingDelta=d("");this.isConnected=d(!1);this.reconnectAttempts=0;this.maxReconnectAttempts=5;this.reconnectDelay=1e3;this.reconnectTimer=null;this.currentSessionId=null}connect(t){this.disconnect(),this.currentSessionId=t,this.reconnectAttempts=0,this.establishConnection(t)}establishConnection(t){let s=this.auth.accessToken();if(!s){console.warn("No access token available - skipping WebSocket connection");return}let o=`${f.wsUrl||f.apiUrl.replace(/^https?:/,"ws:")}/api/v1/ws/chat/${t}?token=${encodeURIComponent(s)}`;this.ws=new WebSocket(o),this.ws.onopen=()=>{this.isConnected.set(!0),this.reconnectAttempts=0,this.reconnectDelay=1e3,console.log("WebSocket connected successfully")},this.ws.onclose=n=>{this.isConnected.set(!1),console.log("WebSocket closed:",n.code,n.reason),n.code===403||n.code===1008?console.error("WebSocket authentication failed"):n.code===1e3?console.log("WebSocket closed normally"):(console.error("WebSocket connection lost unexpectedly"),this.attemptReconnect(t))},this.ws.onerror=n=>{console.error("WebSocket error:",n),this.isConnected.set(!1)}}attemptReconnect(t){if(this.reconnectAttempts>=this.maxReconnectAttempts){this.toast.show("Connection lost. Please refresh the page.","error");return}this.currentSessionId===t&&(this.reconnectAttempts++,console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`),this.reconnectTimer=setTimeout(()=>{this.establishConnection(t)},this.reconnectDelay),this.reconnectDelay=Math.min(this.reconnectDelay*2,3e4))}send(t,s,r){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){this.toast.show("Not connected to chat server. Please try again.","error");return}this.streamingDelta.set("");let o={content:t};this.ws.send(JSON.stringify(o));let n=!0;this.ws.onmessage=a=>{try{let i=JSON.parse(a.data);if(i.content&&(n&&(n=!1,s?.()),this.streamingDelta.update(l=>l+i.content)),i.delta&&(n&&(n=!1,s?.()),this.streamingDelta.update(l=>l+i.delta)),i.done&&(setTimeout(()=>{this.streamingDelta.set("")},500),this.isConnected.set(!0),r?.()),i.error){let l=i.error.toLowerCase();if(l.includes("empty message")||l.includes("message too")){console.debug("WebSocket validation:",i.error);return}console.error("WebSocket streaming error:",i.error),this.toast.show("Error generating response. Please try again.","error")}}catch(i){console.error("Error parsing WebSocket message:",i),this.toast.show("Error receiving message. Please try again.","error")}}}disconnect(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.reconnectAttempts=0,this.currentSessionId=null,this.ws&&(this.streamingDelta.set(""),(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING)&&this.ws.close(1e3,"Client disconnecting"),this.ws=null,this.isConnected.set(!1),console.log("WebSocket disconnected"))}ngOnDestroy(){this.disconnect()}};c.\u0275fac=function(s){return new(s||c)},c.\u0275prov=p({token:c,factory:c.\u0275fac,providedIn:"root"});var S=c;var h=(function(e){return e[e.State=0]="State",e[e.Transition=1]="Transition",e[e.Sequence=2]="Sequence",e[e.Group=3]="Group",e[e.Animate=4]="Animate",e[e.Keyframes=5]="Keyframes",e[e.Style=6]="Style",e[e.Trigger=7]="Trigger",e[e.Reference=8]="Reference",e[e.AnimateChild=9]="AnimateChild",e[e.AnimateRef=10]="AnimateRef",e[e.Query=11]="Query",e[e.Stagger=12]="Stagger",e})(h||{}),D="*";function b(e,t){return{type:h.Trigger,name:e,definitions:t,options:{}}}function F(e,t=null){return{type:h.Animate,styles:t,timings:e}}function W(e,t=null){return{type:h.Sequence,steps:e,options:t}}function w(e){return{type:h.Style,styles:e,offset:null}}function v(e,t,s=null){return{type:h.Transition,expr:e,animation:t,options:s}}var m=class{_onDoneFns=[];_onStartFns=[];_onDestroyFns=[];_originalOnDoneFns=[];_originalOnStartFns=[];_started=!1;_destroyed=!1;_finished=!1;_position=0;parentPlayer=null;totalTime;constructor(t=0,s=0){this.totalTime=t+s}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(t=>t()),this._onDoneFns=[])}onStart(t){this._originalOnStartFns.push(t),this._onStartFns.push(t)}onDone(t){this._originalOnDoneFns.push(t),this._onDoneFns.push(t)}onDestroy(t){this._onDestroyFns.push(t)}hasStarted(){return this._started}init(){}play(){this.hasStarted()||(this._onStart(),this.triggerMicrotask()),this._started=!0}triggerMicrotask(){queueMicrotask(()=>this._onFinish())}_onStart(){this._onStartFns.forEach(t=>t()),this._onStartFns=[]}pause(){}restart(){}finish(){this._onFinish()}destroy(){this._destroyed||(this._destroyed=!0,this.hasStarted()||this._onStart(),this.finish(),this._onDestroyFns.forEach(t=>t()),this._onDestroyFns=[])}reset(){this._started=!1,this._finished=!1,this._onStartFns=this._originalOnStartFns,this._onDoneFns=this._originalOnDoneFns}setPosition(t){this._position=this.totalTime?t*this.totalTime:1}getPosition(){return this.totalTime?this._position/this.totalTime:1}triggerCallback(t){let s=t=="start"?this._onStartFns:this._onDoneFns;s.forEach(r=>r()),s.length=0}},_=class{_onDoneFns=[];_onStartFns=[];_finished=!1;_started=!1;_destroyed=!1;_onDestroyFns=[];parentPlayer=null;totalTime=0;players;constructor(t){this.players=t;let s=0,r=0,o=0,n=this.players.length;n==0?queueMicrotask(()=>this._onFinish()):this.players.forEach(a=>{a.onDone(()=>{++s==n&&this._onFinish()}),a.onDestroy(()=>{++r==n&&this._onDestroy()}),a.onStart(()=>{++o==n&&this._onStart()})}),this.totalTime=this.players.reduce((a,i)=>Math.max(a,i.totalTime),0)}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(t=>t()),this._onDoneFns=[])}init(){this.players.forEach(t=>t.init())}onStart(t){this._onStartFns.push(t)}_onStart(){this.hasStarted()||(this._started=!0,this._onStartFns.forEach(t=>t()),this._onStartFns=[])}onDone(t){this._onDoneFns.push(t)}onDestroy(t){this._onDestroyFns.push(t)}hasStarted(){return this._started}play(){this.parentPlayer||this.init(),this._onStart(),this.players.forEach(t=>t.play())}pause(){this.players.forEach(t=>t.pause())}restart(){this.players.forEach(t=>t.restart())}finish(){this._onFinish(),this.players.forEach(t=>t.finish())}destroy(){this._onDestroy()}_onDestroy(){this._destroyed||(this._destroyed=!0,this._onFinish(),this.players.forEach(t=>t.destroy()),this._onDestroyFns.forEach(t=>t()),this._onDestroyFns=[])}reset(){this.players.forEach(t=>t.reset()),this._destroyed=!1,this._finished=!1,this._started=!1}setPosition(t){let s=t*this.totalTime;this.players.forEach(r=>{let o=r.totalTime?Math.min(1,s/r.totalTime):1;r.setPosition(o)})}getPosition(){let t=this.players.reduce((s,r)=>s===null||r.totalTime>s.totalTime?r:s,null);return t!=null?t.getPosition():0}beforeDestroy(){this.players.forEach(t=>{t.beforeDestroy&&t.beforeDestroy()})}triggerCallback(t){let s=t=="start"?this._onStartFns:this._onDoneFns;s.forEach(r=>r()),s.length=0}},E="!";export{h as a,D as b,b as c,F as d,W as e,w as f,v as g,m as h,_ as i,E as j,S as k};
